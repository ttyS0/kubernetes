apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    matchLabels:
      app: vault
  serviceName: "vault"
  replicas: 2
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: vault
    spec:
      tolerations:
        - key: ceph
          value: osd
          effect: NoSchedule
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values: ['vault']
              topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 10
      containers:
      - name: consul-agent
        image: "consul:1.7.0"
        env:
          - name: GOSSIP_ENCRYPTION_KEY
            valueFrom:
              secretKeyRef:
                key: gossipKey
                name: consul-gossip-key
        args:
          - "agent"
          - "-retry-join=skj-consul-server-0.skj-consul-server.consul.svc.cluster.local"
          - "-retry-join=skj-consul-server-1.skj-consul-server.consul.svc.cluster.local"
          - "-retry-join=skj-consul-server-2.skj-consul-server.consul.svc.cluster.local"
          - "-encrypt=$(GOSSIP_ENCRYPTION_KEY)"
          - "-disable-host-node-id"
          - "-datacenter=home"
        ports:
        - containerPort: 8500
          name: consul-agent
          protocol: TCP
      - name: vault
        image: vault:1.3.3
        imagePullPolicy: IfNotPresent
        args:
        - server
        ports:
        - containerPort: 8200
          name: vault-port
          protocol: TCP
        - containerPort: 8201
          name: cluster-port
          protocol: TCP
        securityContext:
          capabilities:
            add:
            - IPC_LOCK
        env:
        - name: VAULT_LOCAL_CONFIG
          value: |
            api_addr = "https://vault.ttys0.net"
            cluster_addr = "http://vault:8201"
            ui = true
            cluster_name = "home"
            storage "consul" {
              address = "127.0.0.1:8500"
            }
            listener "tcp" {
              address       = "0.0.0.0:8200"
              tls_disable = 1
            }
        - name: VAULT_AWSKMS_SEAL_KEY_ID
          valueFrom:
            secretKeyRef:
              key: kms_key_id
              name: vault-kms-unseal
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: access_key_id
              name: vault-kms-unseal
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: secret_key
              name: vault-kms-unseal
        - name: VAULT_SEAL_TYPE
          value: "awskms"
        - name: AWS_REGION
          value: "us-east-1"
        livenessProbe:
          httpGet:
            path: /v1/sys/health?&sealedcode=200&uninitcode=200&standbycode=200
            port: 8200
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /v1/sys/health
            port: 8200
          initialDelaySeconds: 10
          periodSeconds: 5
        volumeMounts:
          - mountPath: /vault/logs
            name: logs
      - name: vault-logs
        image: busybox
        args: [/bin/sh, -c, 'tail -n+1 -F /vault/logs/audit.log']
        volumeMounts:
          - mountPath: /vault/logs
            name: logs
      volumes:
        - name: logs
          emptyDir: {}


---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    app: vault
  ports:
  - name: vault-api
    port: 8200

---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: vault
  namespace: vault
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  rules:
    - host: vault.ttys0.net
      http:
        paths:
          - path: /
            backend:
              serviceName: vault
              servicePort: 8200
  tls:
    - hosts:
        - vault.ttys0.net
      secretName: vault-tls
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: vault-ext
  namespace: vault
  annotations:
    kubernetes.io/ingress.class: nginx-external
    nginx.ingress.kubernetes.io/whitelist-source-range: '160.129.250.188/32, 160.129.251.199/32'
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  rules:
    - host: vault.ttys0.net
      http:
        paths:
          - path: /
            backend:
              serviceName: vault
              servicePort: 8200
  tls:
    - hosts:
        - vault.ttys0.net
      secretName: vault-tls
