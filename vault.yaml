apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    matchLabels:
      app: vault
  serviceName: "vault"
  replicas: 2
  template:
    metadata:
      labels:
        app: vault
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ['vault']
            topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 10
      nodeSelector:
        beta.kubernetes.io/arch: arm64
      containers:
      - name: consul-agent
        image: "consul:latest"
        args:
        - "agent"
        - "-retry-join=consul-server-0.consul-server.consul.svc.cluster.local"
        - "-retry-join=consul-server-1.consul-server.consul.svc.cluster.local"
        - "-retry-join=consul-server-2.consul-server.consul.svc.cluster.local"
        - "-datacenter=home"
        ports:
        - containerPort: 8500
          name: consul-agent
          protocol: TCP
      - name: vault
        image: vault:1.0.2
        imagePullPolicy: Always
        args:
        - server
        ports:
        - containerPort: 8200
          name: vault-port
          protocol: TCP
        - containerPort: 8201
          name: cluster-port
          protocol: TCP
        securityContext:
          capabilities:
            add:
            - IPC_LOCK
        env:
        - name: VAULT_LOCAL_CONFIG
          value: |
            api_addr = "https://vault.ttys0.net"
            cluster_addr = "http://vault:8201"
            ui = true
            cluster_name = "home"
            storage "consul" {
              address = "127.0.0.1:8500"
            }
            listener "tcp" {
              address       = "0.0.0.0:8200"
              tls_disable = 1
            }
        livenessProbe:
          httpGet:
            path: /v1/sys/health?&sealedcode=200&uninitcode=200&standbycode=200
            port: 8200
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /v1/sys/health
            port: 8200
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    app: vault
  ports:
  - name: vault-api
    port: 8200
---
apiVersion: v1
kind: Service
metadata:
  name: vault
  namespace: web
spec:
  type: ExternalName
  externalName: vault.vault.svc
  ports:
  - port: 8200

---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: vault
  namespace: web
  annotations:
    kubernetes.io/ingress.class: traefik
spec:
  tls:
  - secretName: ttys0-tls
  rules:
  - host: vault.ttys0.net
    http:
      paths:
      - path: /
        backend:
          serviceName: vault
          servicePort: 8200
