---
apiVersion: v1
kind: Namespace
metadata:
  name: vault
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    matchLabels:
      app: vault
  serviceName: "vault"
  replicas: 2
  template:
    metadata:
      labels:
        app: vault
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values: ['vault']
            topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 10
      containers:
      - name: vault
        image: vault:0.11.3
        imagePullPolicy: Always
        args:
        - server
        ports:
        - containerPort: 8200
          name: vault-port
          protocol: TCP
        - containerPort: 8201
          name: cluster-port
          protocol: TCP
        securityContext:
          capabilities:
            add:
            - IPC_LOCK
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: VAULT_LOCAL_CONFIG
          value: |
            api_addr = "https://vault.ttys0.net"
            cluster_addr = "http://vault:8201"
            ui = true
            cluster_name = "home"
            storage "consul" {
              address = "$(NODE_NAME):8500"
            }
            listener "tcp" {
              address       = "0.0.0.0:8200"
              tls_disable = 1
            }
        resources:
          limits:
            cpu: "1"
            memory: "1Gi"
          requests:
            cpu: "500m"
            memory: "256Mi"
        livenessProbe:
          httpGet:
            path: /v1/sys/health?&sealedcode=200&uninitcode=200&standbycode=200
            port: vault-port
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /v1/sys/health
            port: vault-port
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: vault
  name: vault
  namespace: vault
spec:
  selector:
    app: vault
  ports:
  - name: vault-api
    port: 8200
---
apiVersion: contour.heptio.com/v1beta1
kind: IngressRoute
metadata:
  name: web-vault
  namespace: web
spec:
  virtualhost:
    fqdn: vault.ttys0.net
    tls:
      secretName: ttys0-net-tls
  routes:
  - match: /
    delegate:
      name: vault-api
      namespace: vault
---
apiVersion: contour.heptio.com/v1beta1
kind: IngressRoute
metadata:
  name: vault-api
  namespace: vault
spec:
  routes:
  - match: /
    services:
    - name: vault
      port: 8200
