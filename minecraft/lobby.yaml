apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: lobby
  namespace: minecraft
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5G
  storageClassName: shared
---
kind: ConfigMap
apiVersion: v1
metadata:
  namespace: minecraft
  name: lobby-spigot-yml
data:
  spigot-yml: |
    config-version: 12
    settings:
      debug: false
      save-user-cache-on-stop-only: false
      timeout-time: 60
      restart-on-crash: true
      restart-script: ./start.sh
      netty-threads: 4
      attribute:
        maxHealth:
          max: 2048.0
        movementSpeed:
          max: 2048.0
        attackDamage:
          max: 2048.0
      bungeecord: true
      late-bind: false
      sample-count: 12
      player-shuffle: 0
      filter-creative-items: true
      user-cache-size: 1000
      int-cache-limit: 1024
      moved-wrongly-threshold: 0.0625
      moved-too-quickly-multiplier: 10.0
      item-dirty-ticks: 20
    commands:
      send-namespaced: true
      tab-complete: 0
      log: true
      spam-exclusions:
      - /skill
      silent-commandblock-console: false
      replace-commands:
      - setblock
      - summon
      - testforblock
      - tellraw
    messages:
      whitelist: You are not whitelisted on this server!
      unknown-command: Unknown command. Type "/help" for help.
      server-full: The server is full!
      outdated-client: Outdated client! Please use {0}
      outdated-server: Outdated server! I'm still on {0}
      restart: Server is restarting
    stats:
      disable-saving: false
      forced-stats: {}
    advancements:
      disable-saving: false
      disabled:
      - minecraft:story/disabled
    world-settings:
      default:
        seed-desert: 14357617
        seed-igloo: 14357618
        seed-jungle: 14357619
        seed-swamp: 14357620
        seed-shipwreck: 165745295
        seed-ocean: 14357621
        seed-outpost: 165745296
        view-distance: default
        verbose: true
        mob-spawn-range: 4
        growth:
          beetroot-modifier: 100
          carrot-modifier: 100
          potato-modifier: 100
          bamboo-modifier: 100
          sweetberry-modifier: 100
          kelp-modifier: 100
          cactus-modifier: 100
          cane-modifier: 100
          melon-modifier: 100
          mushroom-modifier: 100
          pumpkin-modifier: 100
          sapling-modifier: 100
          wheat-modifier: 100
          netherwart-modifier: 100
          vine-modifier: 100
          cocoa-modifier: 100
        entity-activation-range:
          raiders: 48
          animals: 32
          monsters: 32
          misc: 16
          tick-inactive-villagers: true
        entity-tracking-range:
          players: 48
          animals: 48
          monsters: 48
          misc: 32
          other: 64
        ticks-per:
          hopper-transfer: 8
          hopper-check: 1
        hopper-amount: 1
        random-light-updates: false
        save-structure-info: true
        dragon-death-sound-radius: 0
        seed-village: 10387312
        seed-feature: 14357617
        seed-monument: 10387313
        seed-slime: 987234911
        hunger:
          jump-walk-exhaustion: 0.05
          jump-sprint-exhaustion: 0.2
          combat-exhaustion: 0.1
          regen-exhaustion: 6.0
          swim-multiplier: 0.01
          sprint-multiplier: 0.1
          other-multiplier: 0.0
        max-tnt-per-tick: 100
        max-tick-time:
          tile: 50
          entity: 50
        squid-spawn-range:
          min: 45.0
        enable-zombie-pigmen-portal-spawns: true
        item-despawn-rate: 6000
        merge-radius:
          item: 2.5
          exp: 3.0
        arrow-despawn-rate: 1200
        wither-spawn-sound-radius: 0
        hanging-tick-frequency: 100
        zombie-aggressive-towards-villager: true
        nerf-spawner-mobs: false
        max-entity-collisions: 8
---
kind: ConfigMap
apiVersion: v1
metadata:
  namespace: minecraft
  name: lobby-server-properties
data:
  server-properties: |
    #Minecraft server properties
    broadcast-rcon-to-ops=true
    view-distance=10
    max-build-height=256
    server-ip=
    rcon.port=25575
    level-seed=
    allow-nether=false
    gamemode=creative
    enable-command-block=false
    server-port=25565
    enable-rcon=true
    enable-query=false
    op-permission-level=4
    prevent-proxy-connections=false
    generator-settings=
    resource-pack=
    player-idle-timeout=0
    level-name=world
    rcon.password=admin
    motd=Limbo
    query.port=25565
    force-gamemode=false
    debug=false
    hardcore=false
    white-list=false
    broadcast-console-to-ops=true
    pvp=false
    spawn-npcs=true
    spawn-animals=true
    generate-structures=true
    snooper-enabled=true
    difficulty=hard
    function-permission-level=2
    network-compression-threshold=256
    level-type=default
    spawn-monsters=false
    max-tick-time=60000
    max-players=20
    use-native-transport=true
    enforce-whitelist=false
    spawn-protection=16
    resource-pack-sha1=
    online-mode=false
    allow-flight=true
    max-world-size=1000

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lobby
  namespace: minecraft
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: minecraft
      world: lobby
  template:
    metadata:
      labels:
        app: minecraft
        world: lobby
    spec:
      imagePullSecrets:
        - name: github
      containers:
        - name: lobby
          image: docker.pkg.github.com/ttys0/docker-minecraft/spigot:1.14.4
          ports:
            - containerPort: 25565
          volumeMounts:
            - name: server
              mountPath: /minecraft/server
            - name: server-properties
              mountPath: /minecraft/server/server.properties
              subPath: server.properties
            - name: spigot-yml
              mountPath: /minecraft/server/spigot.yml
              subPath: spigot.yml
          env:
            - name: JVM_OPTS
              value: "-Xms1G -Xmx1G"
      volumes:
        - name: server
          persistentVolumeClaim:
            claimName: lobby
        - name: server-properties
          configMap:
            name: lobby-server-properties
            items:
              - key: server-properties
                path: server.properties
        - name: spigot-yml
          configMap:
            name: lobby-spigot-yml
            items:
              - key: spigot-yml
                path: spigot.yml
---
apiVersion: v1
kind: Service
metadata:
  name: lobby
  namespace: minecraft
  labels:
    app: minecraft
    world: lobby
spec:
  ports:
    - name: server
      port: 25565
      targetPort: 25565
  selector:
    app: minecraft
    world: lobby
