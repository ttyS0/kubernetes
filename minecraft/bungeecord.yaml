apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: bungeecord
  namespace: minecraft
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5G
  storageClassName: shared
---
kind: ConfigMap
apiVersion: v1
metadata:
  namespace: minecraft
  name: bungeecord-yml
data:
  config-yml: |
    player_limit: 10
    ip_forward: true
    permissions:
      default:
        - bungeecord.command.server
        - bungeecord.command.list
      admin:
        - bungeecord.command.alert
        - bungeecord.command.end
        - bungeecord.command.ip
        - bungeecord.command.reload
    timeout: 30000
    log_commands: false
    online_mode: true
    servers:
      lobby:
        motd: '&1Limbo'
        address: lobby:25565
        restricted: false
      amber:
        motd: "&1Amber"
        address: amber:25565
        resricted: false
    listeners:
      - query_port: 25577
        motd: '&1Seans Bungee Server'
        priorities:
          - amber
        bind_local_address: true
        tab_list: GLOBAL_PING
        query_enabled: false
        host: 0.0.0.0:25577
        forced_hosts: {}
        max_players: 0
        tab_size: 60
        ping_passthrough: false
        force_default_server: false
        proxy_protocol: false
    disabled_commands:
      - disabledcommandhere
    network_compression_threshold: 256
    groups:
      ttys0:
        - admin
    connection_throttle: 4000
    connection_throttle_limit: 3
    stats: f2876aa6-74d2-468c-90ee-1377111f1c9f
    forge_support: false
    inject_commands: false

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bungeecord
  namespace: minecraft
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: bungeecord
  template:
    metadata:
      labels:
        app: bungeecord
    spec:
      imagePullSecrets:
        - name: github
      containers:
        - imagePullPolicy: IfNotPresent
          name: bungeecord
          image: docker.pkg.github.com/ttys0/docker-minecraft/bungeecord:1420
          ports:
            - containerPort: 25577
          volumeMounts:
            - name: bungeecord-yml
              mountPath: /config/config.yml
              subPath: config.yml
            - name: bungeecord-plugins
              mountPath: /plugins
          env:
            - name: JVM_OPTS
              value: "-Xms1G -Xmx1G"
      volumes:
        - name: bungeecord-yml
          configMap:
            name: bungeecord-yml
            items:
              - key: config-yml
                path: config.yml
        - name: bungeecord-plugins
          persistentVolumeClaim:
            claimName: bungeecord
---
apiVersion: v1
kind: Service
metadata:
  name: bungeecord
  namespace: minecraft
  labels:
    app: bungeecord
spec:
  type: LoadBalancer
  ports:
    - name: server
      port: 25565
      targetPort: 25577
  selector:
    app: bungeecord
