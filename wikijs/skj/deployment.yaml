apiVersion: apps/v1
kind: Deployment
metadata:
  name: skj
  namespace: wikijs
spec:
  replicas: 1
  selector:
    matchLabels:
      instance: skj
  strategy:
    type: Recreate
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-inject-secret-config.yml: kube/data/wikijs/skj
        vault.hashicorp.com/agent-inject-template-config.yml: |
          {{- with secret "kube/data/wikijs/skj" -}}
          port: 3000
          bindIP: 0.0.0.0
          db:
            type: {{ .Data.data.dbtype }}
            host: '{{ .Data.data.dbhost }}'
            port: {{ .Data.data.dbport }}'
            user: '{{ .Data.data.dbuser }}'
            pass: '{{ .Data.data.dbpass }}'
            db: {{ .Data.data.dbname }}
            storage: $(DB_FILEPATH)
            ssl: $(DB_SSL)
          ssl:
            enabled: $(SSL_ACTIVE)
            port: 3443
            provider: letsencrypt
            domain: $(LETSENCRYPT_DOMAIN)
            subscriberEmail: $(LETSENCRYPT_EMAIL)
          logLevel: $(LOG_LEVEL:info)
          logFormat: $(LOG_FORMAT:default)
          ha: $(HA_ACTIVE)
          {{- end }}
        vault.hashicorp.com/role: kube-wikijs-skj
      labels:
        instance: skj
    spec:
      containers:
        - env:
            - name: CONFIG_FILE
              value: /vault/secrets/config.yml
          image: requarks/wiki:latest
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
          name: wikijs
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
          volumeMounts:
            - mountPath: /wiki/data
              name: data
      dnsConfig:
        options:
          - name: ndots
            value: "1"
      securityContext:
        runAsUser: 1000
        fsGroup: 1000
      serviceAccountName: wikijs-skj
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: skj
